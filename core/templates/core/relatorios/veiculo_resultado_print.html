{% extends "core/base_print.html" %}
{% load static %}
{% load humanize %}

{% block title %}Relatório de Veículo - {{ caminhao.placa }}{% endblock %}

{% block head_extras %}
<style>
    /* Estilos específicos para impressão */
    @page {
        size: A4;
        margin: 1cm;
        margin-bottom: 1.5cm; /* Margem inferior reduzida */
    }
    
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
        line-height: 1.3;
        position: relative;
        min-height: 100vh;
        padding-bottom: 30px; /* Espaço reduzido para o rodapé */
    }
    
    .print-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 15px;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }
    
    .company-info {
        width: 40%;
    }
    
    .report-info {
        width: 55%;
        text-align: right;
    }
    
    .logo-area {
        max-width: 200px;
        max-height: 60px;
        margin-bottom: 8px;
    }
    
    .logo-area img {
        max-width: 100%;
        max-height: 100%;
    }
    
    .company-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .company-razao {
        font-size: 12px;
        margin-bottom: 5px;
    }
    
    .company-address {
        font-size: 11px;
        margin-bottom: 3px;
    }
    
    .company-contact {
        font-size: 11px;
        margin-bottom: 3px;
    }
    
    .report-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .vehicle-info {
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .summary-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .metric-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        width: calc(25% - 10px);
        box-sizing: border-box;
        margin-bottom: 10px;
    }
    
    .metric-card.positive {
        border-left: 4px solid #1cc88a;
    }
    
    .metric-card.negative {
        border-left: 4px solid #e74a3b;
    }
    
    .metric-card.warning {
        border-left: 4px solid #f6c23e;
    }
    
    .metric-card .metric-title {
        font-size: 12px;
        color: #555;
        margin-bottom: 5px;
    }
    
    .metric-card .metric-value {
        font-size: 16px;
        font-weight: bold;
    }
    
    .card-title {
        font-size: 12px;
        color: #555;
        margin-bottom: 5px;
    }
    
    .card-value {
        font-size: 16px;
        font-weight: bold;
    }
    
    .report-section {
        margin-bottom: 20px;
        page-break-inside: avoid;
    }
    
    .report-section h5 {
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 15px;
        font-weight: bold;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px; /* Espaço reduzido para o rodapé */
        font-size: 10px;
    }
    
    th, td {
        border: 1px solid #ddd;
        padding: 5px;
        text-align: left;
    }
    
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    
    tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    .table-costs .category {
        font-weight: bold;
    }
    
    .table-costs .subcategory {
        padding-left: 20px;
    }
    
    .table-costs .total-row {
        font-weight: bold;
        background-color: #f2f2f2;
    }
    
    .valor-monetario {
        white-space: nowrap;
        text-align: right;
    }
    
    .valor-peso {
        white-space: nowrap;
        text-align: right;
    }
    
    /* Sobrescrevendo os estilos do rodapé no template base */
    .print-footer {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        text-align: center !important;
        font-size: 10px !important;
        border-top: 1px solid #ddd !important;
        padding-top: 5px !important;
        padding-bottom: 5px !important;
        line-height: 1.2 !important;
        background-color: white !important;
        height: 20px !important; /* Altura reduzida para o rodapé */
        z-index: 1000 !important; /* Garantir que o rodapé fique acima de outros elementos */
    }
    
    .text-success {
        color: #1cc88a !important;
    }
    
    .text-danger {
        color: #e74a3b !important;
    }
    
    .print-button {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .print-button:hover {
        background-color: #0069d9;
    }
    
    @media print {
        .print-button {
            display: none;
        }
        
        body {
            padding-bottom: 0;
        }
        
        .print-footer {
            position: fixed;
            bottom: 0;
        }
        
        .page-number:after {
            content: counter(page);
        }
    }
    
    @media screen {
        [data-bs-theme="dark"] body, 
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        [data-bs-theme="dark"] .metric-card, 
        body.dark-mode .metric-card {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        [data-bs-theme="dark"] .metric-card.positive, 
        body.dark-mode .metric-card.positive {
            border-left-color: #38b2ac;
        }
        
        [data-bs-theme="dark"] .metric-card.negative, 
        body.dark-mode .metric-card.negative {
            border-left-color: #f56565;
        }
        
        [data-bs-theme="dark"] .metric-card.warning, 
        body.dark-mode .metric-card.warning {
            border-left-color: #ecc94b;
        }
        
        [data-bs-theme="dark"] .metric-card .metric-title, 
        body.dark-mode .metric-card .metric-title {
            color: #a0aec0;
        }
        
        [data-bs-theme="dark"] .metric-card .metric-value, 
        body.dark-mode .metric-card .metric-value {
            color: #e2e8f0;
        }
        
        [data-bs-theme="dark"] .metric-card.positive .metric-value, 
        body.dark-mode .metric-card.positive .metric-value {
            color: #68d391;
        }
        
        [data-bs-theme="dark"] .metric-card.negative .metric-value, 
        body.dark-mode .metric-card.negative .metric-value {
            color: #fc8181;
        }
        
        [data-bs-theme="dark"] .metric-card.warning .metric-value, 
        body.dark-mode .metric-card.warning .metric-value {
            color: #faf089;
        }
        
        [data-bs-theme="dark"] .text-success, 
        body.dark-mode .text-success {
            color: #38b2ac !important;
        }
        
        [data-bs-theme="dark"] .text-danger, 
        body.dark-mode .text-danger {
            color: #f56565 !important;
        }
        
        [data-bs-theme="dark"] .report-section h5, 
        body.dark-mode .report-section h5 {
            color: #e2e8f0;
            border-bottom-color: #4a5568;
        }
        
        [data-bs-theme="dark"] .print-button, 
        body.dark-mode .print-button {
            background-color: #4e83fd;
        }
        
        [data-bs-theme="dark"] .print-button:hover, 
        body.dark-mode .print-button:hover {
            background-color: #3a70e0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Botão de impressão -->
<button class="print-button" onclick="window.print()">Imprimir Relatório</button>

<!-- Conteúdo do relatório -->
<div class="print-content">
    <!-- Informações do Veículo -->
    <div class="report-section">
        <h5>Informações do Veículo</h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Placa:</strong> {{ caminhao.placa }}</p>
                <p><strong>Marca/Modelo:</strong> {{ caminhao.marca }} {{ caminhao.modelo }}</p>
                <p><strong>Ano:</strong> {{ caminhao.ano }}</p>
                <p><strong>Tipo:</strong> {{ caminhao.get_tipo_display }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Proprietário:</strong> {{ caminhao.proprietario }}</p>
                <p><strong>Status:</strong> {{ caminhao.get_status_display }}</p>
                <p><strong>Km Atual:</strong> {{ caminhao.km_atual|intcomma }}</p>
                <p><strong>Capacidade:</strong> {{ caminhao.capacidade_kg|intcomma }} kg</p>
            </div>
        </div>
    </div>

    <!-- Métricas Financeiras -->
    <div class="report-section">
        <h5>Métricas Financeiras</h5>
        <div class="summary-cards">
            <div class="metric-card">
                <div class="metric-title">Receita Total</div>
                <div class="metric-value">R$ {{ metricas.receita_total|floatformat:2|intcomma }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Custos Totais</div>
                <div class="metric-value">R$ {{ metricas.custos_totais|floatformat:2|intcomma }}</div>
            </div>
            <div class="metric-card {% if metricas.lucro_total >= 0 %}positive{% else %}negative{% endif %}">
                <div class="metric-title">Lucro Total</div>
                <div class="metric-value">R$ {{ metricas.lucro_total|floatformat:2|intcomma }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Margem de Lucro</div>
                <div class="metric-value">{{ metricas.margem_lucro|floatformat:2 }}%</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Receita por Km</div>
                <div class="metric-value">R$ {{ metricas.receita_por_km|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Custo por Km</div>
                <div class="metric-value">R$ {{ metricas.custo_por_km|floatformat:2 }}</div>
            </div>
            <div class="metric-card {% if metricas.lucro_por_km >= 0 %}positive{% else %}negative{% endif %}">
                <div class="metric-title">Lucro por Km</div>
                <div class="metric-value">R$ {{ metricas.lucro_por_km|floatformat:2 }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Km Percorridos</div>
                <div class="metric-value">{{ metricas.km_percorridos|intcomma }}</div>
            </div>
        </div>
    </div>

    <!-- Custos Fixos Estimados -->
    <div class="report-section">
        <h5>Custos Fixos Estimados</h5>
        <table class="table table-costs">
            <thead>
                <tr>
                    <th>Categoria</th>
                    <th>Valor Mensal (R$)</th>
                    <th>Valor por Km (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for categoria, subcategorias in custos_fixos.items %}
                    <tr class="category">
                        <td>{{ categoria }}</td>
                        <td class="valor-monetario">{{ subcategorias.total_mensal|floatformat:2|intcomma }}</td>
                        <td class="valor-monetario">{{ subcategorias.total_por_km|floatformat:2 }}</td>
                    </tr>
                    {% for subcategoria, valores in subcategorias.items %}
                        {% if subcategoria != 'total_mensal' and subcategoria != 'total_por_km' %}
                        <tr class="subcategory">
                            <td>{{ subcategoria }}</td>
                            <td class="valor-monetario">{{ valores.mensal|floatformat:2|intcomma }}</td>
                            <td class="valor-monetario">{{ valores.por_km|floatformat:2 }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <tr class="total-row">
                    <td>Total Geral</td>
                    <td class="valor-monetario">{{ total_custos_fixos.mensal|floatformat:2|intcomma }}</td>
                    <td class="valor-monetario">{{ total_custos_fixos.por_km|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Resumo dos Fretes -->
    <div class="report-section">
        <h5>Resumo dos Fretes</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Origem</th>
                    <th>Destino</th>
                    <th>Km</th>
                    <th>Valor (R$)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for frete in fretes %}
                <tr>
                    <td>{{ frete.data_saida|date:"d/m/Y" }}</td>
                    <td>{{ frete.cliente.nome_fantasia }}</td>
                    <td>{{ frete.origem }}</td>
                    <td>{{ frete.destino }}</td>
                    <td class="valor-peso">{{ frete.km_percorrido|default:0|intcomma }}</td>
                    <td class="valor-monetario">{{ frete.valor_total|floatformat:2|intcomma }}</td>
                    <td>
                        {% if frete.status == 'concluido' %}
                        <span class="status-concluido">Concluído</span>
                        {% else %}
                        <span class="status-andamento">Em andamento</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Nenhum frete registrado para este veículo.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block footer %}
<span>TransportadorPRO.com - (64) 9 9611-5182 | {% if empresa %}{{ empresa.nome_fantasia }}{% else %}Sua Empresa{% endif %} | Página <span class="page-number"></span> | Gerado em {% now "d/m/Y H:i" %}</span>
{% endblock %}

{% block scripts %}
<script>
    // Formatação de valores monetários para o padrão brasileiro
    function formatarMoedaBR(valor) {
        if (valor === null || valor === undefined || isNaN(parseFloat(valor))) {
            return "R$ 0,00";
        }
        
        valor = parseFloat(valor);
        
        return valor.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Formatação de valores de peso para o padrão brasileiro
    function formatarPesoBR(valor) {
        if (valor === null || valor === undefined || isNaN(parseFloat(valor))) {
            return "0 kg";
        }
        
        valor = parseFloat(valor);
        
        return valor.toLocaleString('pt-BR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }) + " kg";
    }
    
    // Formatação de valores em colunas de peso sem a unidade
    function formatarPesoSemUnidade(valor) {
        if (valor === null || valor === undefined || isNaN(parseFloat(valor))) {
            return "0";
        }
        
        valor = parseFloat(valor);
        
        return valor.toLocaleString('pt-BR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }
    
    // Executa quando a página carrega
    window.onload = function() {
        // Formatar valores monetários
        document.querySelectorAll('.valor-monetario').forEach(function(elemento) {
            if (elemento.dataset.valor) {
                elemento.textContent = formatarMoedaBR(elemento.dataset.valor);
            }
        });
        
        // Formatar valores de peso
        document.querySelectorAll('.valor-peso').forEach(function(elemento) {
            if (elemento.dataset.valor) {
                elemento.textContent = formatarPesoSemUnidade(elemento.dataset.valor);
            }
        });
        
        // Adicionar evento ao botão de impressão
        document.querySelector('.print-button').addEventListener('click', function() {
            window.print();
        });
    };
</script>
{% endblock %}
